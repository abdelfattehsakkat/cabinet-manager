<div class="patient-list-container">
  <!-- Header Card -->
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>people</mat-icon>
        Liste des Patients
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="header-actions">
        <mat-form-field class="search-field" appearance="outline">
          <mat-label>Rechercher</mat-label>
          <input matInput 
                 (keyup)="applyFilter($event)" 
                 placeholder="N° patient, nom, prénom ou téléphone..." 
                 #input>
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        
        <button mat-raised-button (click)="addNewPatient()" class="add-patient-btn">
          <mat-icon>person_add</mat-icon>
          Nouveau Patient
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Chargement des patients...</p>
  </div>

  <!-- Patients Table Card -->
  <mat-card *ngIf="!isLoading" class="patients-table-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>list</mat-icon>
        Patients Enregistrés
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <div *ngIf="dataSource.data.length === 0" class="no-patients">
        <mat-icon>info</mat-icon>
        <p>Aucun patient trouvé</p>
      </div>

      <div *ngIf="dataSource.data.length > 0" class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="patients-table">
      <ng-container matColumnDef="patientNumber">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> N° Fiche </th>
        <td mat-cell *matCellDef="let patient"> {{patient.patientNumber || 'N/A'}} </td>
      </ng-container>

      <ng-container matColumnDef="lastName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Nom </th>
        <td mat-cell *matCellDef="let patient"> {{patient.lastName}} </td>
      </ng-container>

      <ng-container matColumnDef="firstName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Prénom </th>
        <td mat-cell *matCellDef="let patient"> {{patient.firstName}} </td>
      </ng-container>

      <ng-container matColumnDef="dateOfBirth">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Date de Naissance </th>
        <td mat-cell *matCellDef="let patient"> {{formatDate(patient.dateOfBirth)}} </td>
      </ng-container>

      <ng-container matColumnDef="phone">
        <th mat-header-cell *matHeaderCellDef> Téléphone </th>
        <td mat-cell *matCellDef="let patient"> {{patient.phoneNumber || ''}} </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Actions </th>
        <td mat-cell *matCellDef="let patient">
          <div class="action-buttons">
            <button mat-icon-button class="view-button" (click)="viewPatient(patient)" matTooltip="Voir les détails">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button class="edit-button" (click)="editPatient(patient._id)" matTooltip="Modifier">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button class="delete-button" (click)="deletePatient(patient)" matTooltip="Supprimer">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="6">
          <div class="no-data-message">
            <mat-icon>search_off</mat-icon>
            <span *ngIf="searchTerm">Aucun patient ne correspond à la recherche "{{searchTerm}}"</span>
            <span *ngIf="!searchTerm">Aucun patient trouvé</span>
          </div>
        </td>
      </tr>
        </table>

        <mat-paginator 
          [length]="totalCount"
          [pageSize]="pageSize"
          [pageSizeOptions]="[5, 10, 25, 50]"
          [pageIndex]="currentPage - 1"
          (page)="onPageChange($event)"
          [showFirstLastButtons]="true"
          aria-label="Select page">
        </mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- Patient Details Dialog Template -->
<ng-template #patientDetailsDialog>
  <div class="patient-details-dialog">
    <h2 mat-dialog-title>
      <span>
        <mat-icon>person</mat-icon>
        Détails du Patient
      </span>
      <button mat-icon-button class="close-button" mat-dialog-close>
        <mat-icon>close</mat-icon>
      </button>
    </h2>
    
    <mat-dialog-content>
      <!-- Section informations principales -->
      <div class="primary-info">
        <div class="patient-name">
          <div class="patient-icon">
            <mat-icon>person</mat-icon>
          </div>
          {{selectedPatient?.firstName}} {{selectedPatient?.lastName}}
        </div>
        <div class="patient-details">
          <div class="detail-badge">
            <mat-icon>badge</mat-icon>
            Patient N° {{selectedPatient?.patientNumber || 'N/A'}}
          </div>
          <div class="detail-badge" *ngIf="selectedPatient?.dateOfBirth">
            <mat-icon>cake</mat-icon>
            {{calculateAge(selectedPatient?.dateOfBirth)}} ans
          </div>
        </div>
      </div>

      <!-- Grille d'informations -->
      <div class="patient-info">
        <!-- Carte Informations personnelles -->
        <div class="info-card">
          <div class="info-header">
            <div class="info-icon">
              <mat-icon>person_outline</mat-icon>
            </div>
            <div class="info-title">Informations personnelles</div>
          </div>
          <div class="info-content">
            <div class="info-item">
              <div class="label">Date de naissance</div>
              <div class="value highlight">{{formatDate(selectedPatient?.dateOfBirth)}}</div>
            </div>
          </div>
        </div>

        <!-- Carte Contact -->
        <div class="info-card">
          <div class="info-header">
            <div class="info-icon">
              <mat-icon>contact_phone</mat-icon>
            </div>
            <div class="info-title">Contact</div>
          </div>
          <div class="info-content">
            <div class="info-item" *ngIf="selectedPatient?.phoneNumber">
              <div class="label">Téléphone</div>
              <div class="value">{{selectedPatient?.phoneNumber}}</div>
            </div>
            <div class="info-item" *ngIf="selectedPatient?.email">
              <div class="label">Email</div>
              <div class="value">{{selectedPatient?.email}}</div>
            </div>
          </div>
        </div>

        <!-- Carte Adresse -->
        <div class="info-card" *ngIf="selectedPatient?.address">
          <div class="info-header">
            <div class="info-icon">
              <mat-icon>home</mat-icon>
            </div>
            <div class="info-title">Adresse</div>
          </div>
          <div class="info-content">
            <div class="info-item">
              <div class="label">Adresse complète</div>
              <div class="value">{{selectedPatient?.address}}</div>
            </div>
          </div>
        </div>

        <!-- Carte Informations médicales -->
        <div class="info-card" *ngIf="selectedPatient?.medicalHistory?.notes">
          <div class="info-header">
            <div class="info-icon">
              <mat-icon>medical_services</mat-icon>
            </div>
            <div class="info-title">Notes médicales</div>
          </div>
          <div class="info-content">
            <div class="info-item">
              <div class="label">Historique</div>
              <div class="value">{{selectedPatient?.medicalHistory?.notes}}</div>
            </div>
          </div>
        </div>
      </div>
    </mat-dialog-content>
    
    <mat-dialog-actions>
      <div class="action-group">
        <button mat-button class="secondary-button" mat-dialog-close>
          <mat-icon>close</mat-icon>
          Fermer
        </button>
      </div>
      <div class="action-group">
        <button mat-raised-button class="treatments-button" (click)="viewPatientTreatments()">
          <mat-icon>medical_services</mat-icon>
          Voir les soins
        </button>
        <button mat-raised-button class="primary-button" (click)="editPatientFromDialog()">
          <mat-icon>edit</mat-icon>
          Modifier
        </button>
      </div>
    </mat-dialog-actions>
  </div>
</ng-template>
